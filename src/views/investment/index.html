{% extends "layouts/ukti.html" %}

{% block main %}

{% import "macros/trade.html" as trade %}

<h1 class="heading-xlarge">Create an investment project</h1>

<h2 class="heading-medium">Client summary</h2>

{{ trade.keyvaluetable(
investmentDisplay,
stripey=true,
labels=investmentDetailLabels,
keyorder=investmentDetailsDisplayOrder,
id="investment-details")
}}

<form class="searchbar" action="/search" method="get" role="search">
  <div class="searchbar__wrapper">
    <label class="searchbar__label" for="inv-search">Source of foreign investment</label>
    <input class="searchbar__input form-control" id="inv-search" type="search" name="term" value="" placeholder="Search for company name or contact">
    <input class="searchbar__submit" type="submit" value="Search">
  </div>
</form>

<div id="inv-results" style="display:none"></div>

<style>
.inv-result {
  padding: 14px 0;
  border-top: 1px solid #CCC;
}

  #inv-results {
    border-bottom: 1px solid #CCC;
    clear: both;
  }

  .inv-hidden {
    display: none;
  }


</style>
<script type="application/javascript">

  var countryids = {
    "4ed85f99-7e27-4041-ae7f-0440d2b36958": "UK",
    "6abbee91-7b85-49b8-a133-d59455dc2aad": "Russia",
    "1cb43855-31f9-4cc6-a9a7-893ba5fb0328": "USA",
    "2cdcb25b-6fe3-4ada-b1be-81222e927cee": "Hong Kong"
  }


  var searchfield =document.querySelector("#inv-search");
  var resultsdiv = document.querySelector("#inv-results");


  var companyTemplate = "<a href='#'>[[name]]</a>" +
    "<br>[[address]]</div>" +
      "<div class='inv-hidden'>" +
      "<table class='table--key-value  table--readonly'>"+
        "<tr>" +
          "<td>Company Type</td>" +
          "<td>[[company_type]]</td>" +
        "</tr>"+
      "<tr>" +
        "<td>Investment in the UK</td>" +
        "<td>[[investment_projects]]</td>" +
      "</tr>"+
      "<tr>" +
        "<td>Account tier</td>" +
        "<td>[[account_tier]]</td>" +
      "</tr>"+
      "<tr>" +
        "<td>Account Manager in the UK</td>" +
        "<td>[[account_manager]]</td>" +
      "</tr>"+
    "</table>"+
    "<div class='save-bar'>" +
      "<button class='button button--save' type='submit'>Choose company</button>" +
      "<a class='button-link button--cancel js-button-cancel' href='#'>Close</a>" +
    "</div>" +
      "</div>";


  function toggle_sub(ev) {
    var hid = this.querySelector('.inv-hidden');

    if (!hid.data || hid.data == "hidden") {
      hid.style.display = "block";
      hid.data ="showing";
    } else {
      hid.style.display = "none";
      hid.data ="hidden";
    }
  }

  function ifdef(thing, replacer) {
      var replacer = replacer || "";
      return (!!thing) ? thing : replacer;
  }

  function updateSearchField(res) {
      resultsdiv.style.display = "block";
      resultsdiv.innerHTML = "";
      document.querySelector("#new_co_nagger").style.display = "block";
      var companies = JSON.parse(res.response);
      Object.keys(companies).forEach(function(key){
          var co = companies[key];
          var d = document.createElement("div");
          d.id = "inv-res-" + key;
          d.className = "inv-result";
          var divtext = companyTemplate.replace("[[name]]", co._source.name)
          divtext = divtext.replace("[[address]]", ifdef(co._source.registered_address_1) + ", " + ifdef(co._source.registered_address_town) + " " + countryids[co._source.registered_address_country])
          divtext = divtext.replace("[[company_type]]", "Foreign company");
          divtext = divtext.replace("[[investment_projects]]", co.details.length);
          divtext = divtext.replace("[[account_tier]]", co.summary.investment_tier);
          divtext = divtext.replace("[[account_manager]]", co.summary.investment_account_manager.name);
          d.innerHTML = divtext;
          d.addEventListener("click", toggle_sub, false);
        resultsdiv.appendChild(d);
      })
  }

function searchCos(term) {
  var companyRequest = new XMLHttpRequest();
  companyRequest.onreadystatechange = function() {
    if (companyRequest.readyState === 4) {
      updateSearchField(companyRequest);
    }
  }

  companyRequest.open("GET", "/api/investment/search/" + term);
  companyRequest.send();
}

searchfield.addEventListener("keyup", function() {
    searchCos(searchfield.value)
}, true);
</script>

  <p class="infostrip" style="display:none" id="new_co_nagger">If you can’t find the company you’re looking for, <a href="/company/add-step-2/">create a new company</a>. Unfortunately you will lose your progress.</p>

{% endblock %}}
